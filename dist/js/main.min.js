/*
 noix 2016-09-22 
*/
var TETRIS=function(){var a,b,c=!1,d={},e={},f={},g={},h="IS_PAUSED",i=function(a,b){var d=b||"log";c&&console[d](a)},j=function(a,b){return"string"!=typeof a||"function"!=typeof b?(i("Invalid parameters : Failed to create Module "+a,"error"),!1):void(e[a]={construct:b,instance:null})},k=function(a){return"string"!=typeof a||"undefined"==typeof e[a]?(i("Failed to start module "+a,"error"),!1):(e[a].instance=e[a].construct(TETRIS_SANDBOX.create(d,a)),void e[a].instance.init())},l=function(){for(var a in e)k(a)},m=function(a){return"string"!=typeof a||"undefined"==typeof e[a]?(i("Failed to stop module "+a,"error"),!1):(e[a].instance.destroy(),void(e[a].instance=null))},n=function(){for(var a in e)m(a)},o=function(a,b){return"string"!=typeof a||"function"!=typeof b?(i("Invalid parameters : Failed to create Event "+a,"error"),!1):("undefined"==typeof f[a]&&(f[a]=[]),void f[a].push(b))},p=function(a,b){if("string"!=typeof a)return i("Failed to trigger Event "+a,"error"),!1;if("undefined"==typeof f[a])return i('Event "'+a+"\" hasn't been created yet","warn"),!1;for(var c=0;c<f[a].length;c++)f[a][c].apply({},b)},q=function(a,b,c){a.addEventListener(b,c)},r=function(a,b,c){a.removeEventListener(b,c)},s=function(){console.log("checking rows");var a,b,c=!0;for(a=0;a<g.rows;a++){for(c=!0,b=0;b<g.cols;b++)if(0===g.grid[a][b]){c=!1;break}if(c){g.grid.splice(a,1);var d=[];for(b=0;b<g.cols;b++)d.push(0);g.grid.unshift(d),p("row-cleared")}}},t=function(a,b){return b<=0||"undefined"==typeof g.grid?0:g.grid[b/g.cellSize][a/g.cellSize]},u=function(){return g},v=function(a,b){g[a]=b},w=function(c,d,e){a=document.createElement("canvas"),b=a.getContext("2d"),a.width=d,a.height=e,document.getElementById(c).appendChild(a)},x=function(){a.width=a.width},y=function(a,c,d,e,f){b.rect(a,c,d,e),b.fillStyle=f,b.fillRect(a,c,d,e),b.strokeStyle="#fff",b.stroke()},z=function(){return h},A=function(a){h=a},B=function(b,c,d,e){w(b,c,d),g={width:c,height:d,cellSize:e,rows:a.height/e,cols:a.width/e},o("sigil-settled",s)};return d={registerModule:j,initModule:k,initAllModules:l,destroyModule:m,destroyAllModules:n,subscribeEvent:o,publishEvent:p,addEventListener:q,removeEventListener:r,createCanvas:w,clearCanvas:x,drawRect:y,checkRows:s,checkCell:t,getGridData:u,setGridData:v,getGameState:z,setGameState:A,initGame:B}}(),TETRIS_SANDBOX=function(){var a,b,c=function(b,c){a.subscribeEvent(b,c)},d=function(b,c){a.publishEvent(b,c)},e=function(b,c,d){a.addEventListener(b,c,d)},f=function(b,c,d){a.removeEventListener(b,c,d)},g=function(){a.clearCanvas()},h=function(b,c,d,e,f){a.drawRect(b,c,d,e,f)},i=function(b,c){return a.checkCell(b,c)},j=function(){return a.checkRows()},k=function(b,c){return a.setGridData(b,c)},l=function(){return a.getGridData()},m=function(b){return a.setGameState(b)},n=function(){return a.getGameState()},o=function(o,p){return a=o,b=p,{subscribeEvent:c,publishEvent:d,addEventListener:e,removeEventListener:f,clearCanvas:g,drawRect:h,checkCell:i,checkRows:j,setGridData:k,getGridData:l,getGameState:n,setGameState:m}};return{create:o}}();TETRIS.registerModule("game-controller",function(a){var b=function(b){switch(b.keyCode){case 37:a.publishEvent("move-sigil",["left"]);break;case 38:a.publishEvent("rotate-sigil");break;case 39:a.publishEvent("move-sigil",["right"]);break;case 40:a.publishEvent("move-sigil",["down"]);break;case 32:}},c=function(){a.addEventListener(window,"keydown",b),a.removeEventListener(window,"keyup",c)},d=function(c){_isPaused=c,_isPaused?a.removeEventListener(window,"keydown",b):a.addEventListener(window,"keydown",b)},e=function(){a.addEventListener(window,"keydown",b),a.subscribeEvent("toggle-pause",d)},f=function(){a.removeEventListener(window,"keydown",b),a.removeEventListener(window,"keyup",c)};return{init:e,destroy:f}}),TETRIS.registerModule("game-keeper",function(a){var b=0,c=1,d=0,e=5,f=!1,g=function(){b+=101,document.getElementById("score").innerHTML="Score: "+b,d++,c!=Math.floor(d/e)+1&&(c=Math.floor(d/e)+1,document.getElementById("level").innerHTML="Level: "+c,a.publishEvent("level-up"))},h=function(){a.subscribeEvent("row-cleared",g),document.getElementById("btn-togglePlay").addEventListener("click",function(b){f=!f,f?(b.currentTarget.innerHTML="PLAY",a.setGameState("IS_PAUSED")):(b.currentTarget.innerHTML="PAUSE",a.setGameState("IS_PLAYING"))})},i=function(){};return{init:h,destroy:i}}),TETRIS.registerModule("game-loop",function(a){var b,c,d,e,f=1e3/15,g=1e3/30,h=function(){switch(_currTime=(new Date).getTime(),a.getGameState()){case"IS_PLAYING":e=_currTime-d,e>g&&(a.publishEvent("update"),d=_currTime),e=_currTime-c,e>f&&(a.clearCanvas(),a.publishEvent("render"),c=_currTime);break;case"IS_PAUSED":break;case"IS_STOPPED":}b=window.requestAnimationFrame(h)},i=function(){c=d=(new Date).getTime(),b||window.requestAnimationFrame(h)},j=function(){b&&window.cancelAnimationFrame(b)};return{init:i,destroy:j}}),TETRIS.registerModule("grid",function(a){var b=function(){var b,c;for(b=0;b<a.getGridData().rows;b++)for(c=0;c<a.getGridData().cols;c++)1===a.getGridData().grid[b][c]?a.drawRect(c*a.getGridData().cellSize,b*a.getGridData().cellSize,a.getGridData().cellSize,a.getGridData().cellSize,"#333"):a.drawRect(c*a.getGridData().cellSize,b*a.getGridData().cellSize,a.getGridData().cellSize,a.getGridData().cellSize,"#ddd")},c=function(b,c,d){for(var e=0;e<b.length;e++)if(1==b[e]){var f=c+e%4*a.getGridData().cellSize,g=d+Math.floor(e/4)*a.getGridData().cellSize;a.getGridData().grid[g/a.getGridData().cellSize][f/a.getGridData().cellSize]=1}a.setGridData("grid",a.getGridData().grid),a.publishEvent("sigil-settled")},d=function(){var d,e,f,g=[];for(d=0;d<a.getGridData().rows;d++){for(f=[],e=0;e<a.getGridData().cols;e++)f.push(0);g.push(f)}a.setGridData("grid",g),a.subscribeEvent("render",b),a.subscribeEvent("sigil-fixed",c)},e=function(){};return{init:d,destroy:e}}),TETRIS.registerModule("sigil",function(a){var b,c,d,e,f=[[[0],[1],[0],[0],[0],[1],[0],[0],[0],[1],[1],[0],[0],[0],[0],[0]],[[0],[0],[1],[0],[0],[0],[1],[0],[0],[1],[1],[0],[0],[0],[0],[0]],[[0],[0],[0],[0],[0],[1],[1],[0],[0],[1],[1],[0],[0],[0],[0],[0]],[[0],[0],[0],[0],[1],[1],[1],[0],[0],[1],[0],[0],[0],[0],[0],[0]],[[0],[1],[0],[0],[0],[1],[0],[0],[0],[1],[0],[0],[0],[1],[0],[0]],[[0],[0],[1],[0],[0],[1],[1],[0],[0],[1],[0],[0],[0],[0],[0],[0]],[[0],[1],[0],[0],[0],[1],[1],[0],[0],[0],[1],[0],[0],[0],[0],[0]]],g=2,h=0,j=4,k=f[Math.floor(Math.random()*f.length)],l=function(){for(var f=0;f<e.length;f++){var g=c+Math.floor(f%j)*b,h=d+Math.floor(f/j)*b;1===e[f][0]&&a.drawRect(g,h,b,b,"#52bbae")}},m=function(){h+=g,h>=b&&(h=0,n("down"))},n=function(f){switch(f){case"right":r(e,b,0)&&(c+=b);break;case"left":r(e,-b,0)&&(c-=b);break;case"down":r(e,0,b)?d+=b:a.publishEvent("sigil-fixed",[e,c,d])}},o=function(){var a=[],b=0;for(a.length=e.length,b=0;b<e.length;b++){var c=b%j,d=Math.floor(b/j),f=j-d-1,g=c,h=g*j+f;a[h]=e[b]}q(a)&&(e=a)},p=function(){g+=2},q=function(e){var f,g;for(i=0;i<e.length;i++)if(1==e[i]){if(f=c+Math.floor(i%j)*b,g=d+Math.floor(i/j)*b,f<0)return!!r(e,b,0)&&(c+=f*-1,!0);if(f>=a.getGridData().width)return!!r(e,-b,0)&&(c+=f-(a.getGridData().width+b),!0);if(g>=a.getGridData().height)return d+=g-(a.getGridData().height+b),!0;if(1===a.checkCell(f,g))return f-c>=80?!!r(e,-b,0)&&(c-=b,!0):!!r(e,+b,0)&&(c+=b,!0)}return!0},r=function(e,f,g){for(i=0;i<e.length;i++){var h=c+Math.floor(i%j)*b+f,k=d+Math.floor(i/j)*b+g;if(1==e[i]){if(h<0||h>=a.getGridData().width)return!1;if(k>=a.getGridData().height)return!1;if(1===a.checkCell(h,k))return!1}}return!0},s=function(){c=3*b,d=0,e=k,k=f[Math.floor(Math.random()*f.length)];for(var a=0;a<Math.floor(3*Math.random());a++)o();r(e,0,-b)&&(d-=b)},t=function(){b=a.getGridData().cellSize,s(),a.subscribeEvent("move-sigil",n),a.subscribeEvent("rotate-sigil",o),a.subscribeEvent("sigil-settled",s),a.subscribeEvent("render",l),a.subscribeEvent("update",m),a.subscribeEvent("level-up",p)},u=function(){};return{init:t,destroy:u}}),TETRIS.initGame("game-canvas",300,600,30),TETRIS.initAllModules();