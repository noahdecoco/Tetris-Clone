/*
 noix 2016-09-20 
*/
var GAME_CORE=function(){var a,b,c=!1,d={},e={},f={},g={},h=function(a,b){var d=b||"log";c&&console[d](a)},i=function(a,b){return"string"!=typeof a||"function"!=typeof b?(h("Invalid parameters : Failed to create Module "+a,"error"),!1):void(e[a]={construct:b,instance:null})},j=function(a){return"string"!=typeof a||"undefined"==typeof e[a]?(h("Failed to start module "+a,"error"),!1):(e[a].instance=e[a].construct(GAME_SANDBOX.create(d,a)),void e[a].instance.init())},k=function(){for(var a in e)j(a)},l=function(a){return"string"!=typeof a||"undefined"==typeof e[a]?(h("Failed to stop module "+a,"error"),!1):(e[a].instance.destroy(),void(e[a].instance=null))},m=function(){for(var a in e)l(a)},n=function(a,b){return"string"!=typeof a||"function"!=typeof b?(h("Invalid parameters : Failed to create Event "+a,"error"),!1):("undefined"==typeof f[a]&&(f[a]=[]),void f[a].push(b))},o=function(a,b){if("string"!=typeof a)return h("Failed to trigger Event "+a,"error"),!1;if("undefined"==typeof f[a])return h('Event "'+a+"\" hasn't been created yet","warn"),!1;for(var c=0;c<f[a].length;c++)f[a][c].apply({},b)},p=function(a,b,c){a.addEventListener(b,c)},q=function(a,b,c){a.removeEventListener(b,c)},r=function(){console.log("checking rows");var a,b,c=!0;for(a=0;a<g.rows;a++){for(c=!0,b=0;b<g.cols;b++)if(0===g.grid[a][b]){c=!1;break}if(c){g.grid.splice(a,1);var d=[];for(b=0;b<g.cols;b++)d.push(0);g.grid.unshift(d)}}},s=function(){},t=function(a,b){return g.grid[b/g.cellSize][a/g.cellSize]},u=function(){return g},v=function(a,b){g[a]=b},w=function(c,d,e){a=document.createElement("canvas"),b=a.getContext("2d"),a.width=d,a.height=e,document.getElementById(c).appendChild(a)},x=function(){a.width=a.width},y=function(a,c,d,e,f){b.rect(a,c,d,e),b.fillStyle=f,b.fillRect(a,c,d,e),b.strokeStyle="#fff",b.stroke()},z=function(b,c,d,e){w(b,c,d),g.cellSize=e,g.rows=a.height/e,g.cols=a.width/e,n("sigil-settled",r)};return d={registerModule:i,startModule:j,startAllModules:k,stopModule:l,stopAllModules:m,subscribeEvent:n,publishEvent:o,addEventListener:p,removeEventListener:q,createCanvas:w,clearCanvas:x,drawRect:y,checkRows:r,clearRows:s,checkCell:t,getGridData:u,setGridData:v,initGame:z}}(),GAME_SANDBOX=function(){var a,b,c=function(b,c){a.subscribeEvent(b,c)},d=function(b,c){a.publishEvent(b,c)},e=function(b,c,d){a.addEventListener(b,c,d)},f=function(b,c,d){a.removeEventListener(b,c,d)},g=function(){a.clearCanvas()},h=function(b,c,d,e,f){a.drawRect(b,c,d,e,f)},i=function(b,c){return a.checkCell(b,c)},j=function(){return a.checkRows()},k=function(b,c){return a.setGridData(b,c)},l=function(){return a.getGridData()},m=function(m,n){return a=m,b=n,{subscribeEvent:c,publishEvent:d,addEventListener:e,removeEventListener:f,clearCanvas:g,drawRect:h,checkCell:i,checkRows:j,setGridData:k,getGridData:l}};return{create:m}}();GAME_CORE.registerModule("game-controller",function(a){var b=function(b){switch(b.keyCode){case 37:a.publishEvent("move-sigil",["left"]);break;case 38:a.publishEvent("rotate-sigil");break;case 39:a.publishEvent("move-sigil",["right"]);break;case 40:a.publishEvent("move-sigil",["down"]);break;case 32:a.publishEvent("slam")}},c=function(){a.addEventListener(window,"keydown",b),a.removeEventListener(window,"keyup",c)},d=function(){a.addEventListener(window,"keydown",b)},e=function(){a.removeEventListener(window,"keydown",b),a.removeEventListener(window,"keyup",c)};return{init:d,destroy:e}}),GAME_CORE.registerModule("game-loop",function(a){var b,c,d,e,f=1e3/30,g=1e3/30,h=function(){a.publishEvent("update")},i=function(){a.clearCanvas(),a.publishEvent("render")},j=function(){_currTime=(new Date).getTime(),e=_currTime-d,e>g&&(h(),d=_currTime),e=_currTime-c,e>f&&(i(),c=_currTime),b=window.requestAnimationFrame(j)},k=function(){c=d=(new Date).getTime(),b||window.requestAnimationFrame(j)},l=function(){console.log("Destroyed"),b&&window.cancelAnimationFrame(b)};return{init:k,destroy:l}}),GAME_CORE.registerModule("grid",function(a){var b=function(){var b,c;for(b=0;b<a.getGridData().rows;b++)for(c=0;c<a.getGridData().cols;c++)1===a.getGridData().grid[b][c]?a.drawRect(c*a.getGridData().cellSize,b*a.getGridData().cellSize,a.getGridData().cellSize,a.getGridData().cellSize,"#333"):a.drawRect(c*a.getGridData().cellSize,b*a.getGridData().cellSize,a.getGridData().cellSize,a.getGridData().cellSize,"#ddd")},c=function(b,c,d){for(var e=0;e<b.length;e++)if(1==b[e]){var f=c+e%4*a.getGridData().cellSize,g=d+Math.floor(e/4)*a.getGridData().cellSize;a.getGridData().grid[g/a.getGridData().cellSize][f/a.getGridData().cellSize]=1}a.setGridData("grid",a.getGridData().grid),a.publishEvent("sigil-settled")},d=function(){var d,e,f,g=[];for(d=0;d<a.getGridData().rows;d++){for(f=[],e=0;e<a.getGridData().cols;e++)f.push(0);g.push(f)}a.setGridData("grid",g),a.subscribeEvent("render",b),a.subscribeEvent("sigil-fixed",c)},e=function(){};return{init:d,destroy:e}}),GAME_CORE.registerModule("sigil",function(a){var b,c,d,e,f=[[[0],[1],[0],[0],[0],[1],[0],[0],[0],[1],[1],[0],[0],[0],[0],[0]],[[0],[0],[1],[0],[0],[0],[1],[0],[0],[1],[1],[0],[0],[0],[0],[0]],[[0],[0],[0],[0],[0],[1],[1],[0],[0],[1],[1],[0],[0],[0],[0],[0]],[[0],[0],[0],[0],[1],[1],[1],[0],[0],[1],[0],[0],[0],[0],[0],[0]],[[0],[1],[0],[0],[0],[1],[0],[0],[0],[1],[0],[0],[0],[1],[0],[0]],[[0],[0],[1],[0],[0],[1],[1],[0],[0],[1],[0],[0],[0],[0],[0],[0]],[[0],[1],[0],[0],[0],[1],[1],[0],[0],[0],[1],[0],[0],[0],[0],[0]]],g=2,h=0,j=4,k=f[Math.floor(Math.random()*f.length)],l=function(){for(var f=0;f<e.length;f++){var g=c+Math.floor(f%j)*b,h=d+Math.floor(f/j)*b;1===e[f][0]&&a.drawRect(g,h,b,b,"#52bbae")}},m=function(){h+=g,h>=b&&(h=0,n("down"))},n=function(f){switch(f){case"right":q(b)&&(c+=b);break;case"left":q(-b)&&(c-=b);break;case"down":r(b)?d+=b:a.publishEvent("sigil-fixed",[e,c,d])}},o=function(){var a=[],b=0;for(a.length=e.length,b=0;b<e.length;b++){var c=b%j,d=Math.floor(b/j),f=j-d-1,g=c,h=g*j+f;a[h]=e[b]}e=a,p()},p=function(){for(i=0;i<e.length;i++){var a=c+Math.floor(i%j)*b,f=d+Math.floor(i/j)*b;a<0&&1==e[i]&&(c+=a*-1),a>=400&&1==e[i]&&(c+=a-(400+b)),f>=600&&1==e[i]&&(d+=f-(600+b))}},q=function(f){for(i=0;i<e.length;i++){var g=c+Math.floor(i%j)*b+f,h=d+Math.floor(i/j)*b;if(1==e[i]&&(g<0||g>=400||1===a.checkCell(g,h)))return!1}return!0},r=function(f){for(i=0;i<e.length;i++){var g=c+Math.floor(i%j)*b,h=d+Math.floor(i/j)*b+f;if(1==e[i]&&(h>=600||1===a.checkCell(g,h)))return!1}return!0},s=function(){c=3*b,d=0,e=k,k=f[Math.floor(Math.random()*f.length)];for(var a=0;a<Math.floor(3*Math.random());a++)o()},t=function(){b=a.getGridData().cellSize,s(),a.subscribeEvent("move-sigil",n),a.subscribeEvent("rotate-sigil",o),a.subscribeEvent("sigil-settled",s),a.subscribeEvent("render",l),a.subscribeEvent("update",m)},u=function(){};return{init:t,destroy:u}}),GAME_CORE.initGame("game-canvas",400,600,40),GAME_CORE.startModule("game-loop"),GAME_CORE.startModule("game-controller"),GAME_CORE.startModule("grid"),GAME_CORE.startModule("sigil");