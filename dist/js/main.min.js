/*
 noix 2016-09-25 
*/
var TETRIS=function(){var a,b,c=!1,d={},e={},f={},g={},h="IS_PLAYING",i=function(a,b){var d=b||"log";c&&console[d](a)},j=function(a,b){return"string"!=typeof a||"function"!=typeof b?(i("Invalid parameters : Failed to create Module "+a,"error"),!1):void(e[a]={construct:b,instance:null})},k=function(a){return"string"!=typeof a||"undefined"==typeof e[a]?(i("Failed to start module "+a,"error"),!1):(e[a].instance=e[a].construct(TETRIS_SANDBOX.create(d,a)),void e[a].instance.init())},l=function(){for(var a in e)k(a)},m=function(a){return"string"!=typeof a||"undefined"==typeof e[a]?(i("Failed to stop module "+a,"error"),!1):(e[a].instance.destroy(),void(e[a].instance=null))},n=function(){for(var a in e)m(a)},o=function(a,b){return"string"!=typeof a||"function"!=typeof b?(i("Invalid parameters : Failed to create Event "+a,"error"),!1):("undefined"==typeof f[a]&&(f[a]=[]),void f[a].push(b))},p=function(a,b){if("string"!=typeof a)return i("Failed to trigger Event "+a,"error"),!1;if("undefined"==typeof f[a])return i('Event "'+a+"\" hasn't been created yet","warn"),!1;for(var c=0;c<f[a].length;c++)f[a][c].apply({},b)},q=function(a,b,c){a.addEventListener(b,c)},r=function(a,b,c){a.removeEventListener(b,c)},s=function(){if(console.log("checking rows"),"IS_OVER"!==h){var a,b,c=!0;for(a=0;a<g.rows;a++){for(c=!0,b=0;b<g.cols;b++)if(0===g.grid[a][b]){c=!1;break}if(c){g.grid.splice(a,1);var d=[];for(b=0;b<g.cols;b++)d.push(0);g.grid.unshift(d),p("row-cleared")}}}},t=function(a,b){return b<=0||"undefined"==typeof g.grid?0:g.grid[b/g.cellSize][a/g.cellSize]},u=function(){return g},v=function(a,b){g[a]=b},w=function(c,d,e){a=document.createElement("canvas"),b=a.getContext("2d"),a.width=d,a.height=e,document.getElementById(c).appendChild(a)},x=function(){a.width=a.width},y=function(a,c,d,e,f){b.rect(a,c,d,e),b.fillStyle=f,b.fillRect(a,c,d,e),b.strokeStyle="#fff",b.stroke()},z=function(){return h},A=function(a){h=a},B=function(b,c,d,e){w(b,c,d),g={width:c,height:d,cellSize:e,rows:a.height/e,cols:a.width/e}},C=function(){p("game-start")},D=function(){p("game-start")};return d={registerModule:j,initModule:k,initAllModules:l,destroyModule:m,destroyAllModules:n,subscribeEvent:o,publishEvent:p,addEventListener:q,removeEventListener:r,createCanvas:w,clearCanvas:x,drawRect:y,checkRows:s,checkCell:t,getGridData:u,setGridData:v,getGameState:z,setGameState:A,initGame:B,startGame:C,replayGame:D}}(),TETRIS_SANDBOX=function(){var a,b,c=function(b,c){a.subscribeEvent(b,c)},d=function(b,c){a.publishEvent(b,c)},e=function(b,c,d){a.addEventListener(b,c,d)},f=function(b,c,d){a.removeEventListener(b,c,d)},g=function(){a.clearCanvas()},h=function(b,c,d,e,f){a.drawRect(b,c,d,e,f)},i=function(b,c){return a.checkCell(b,c)},j=function(){return a.checkRows()},k=function(b,c){return a.setGridData(b,c)},l=function(){return a.getGridData()},m=function(b){return a.setGameState(b)},n=function(){return a.getGameState()},o=function(o,p){return a=o,b=p,{subscribeEvent:c,publishEvent:d,addEventListener:e,removeEventListener:f,clearCanvas:g,drawRect:h,checkCell:i,checkRows:j,setGridData:k,getGridData:l,getGameState:n,setGameState:m}};return{create:o}}();TETRIS.registerModule("game-controller",function(a){var b,c,d,e=!1,f=!1,g=!1,h=!1,i=function(c){f?(g?(a.publishEvent("game-stateChange",["game-play"]),b.innerHTML="PAUSE"):(a.publishEvent("game-stateChange",["game-pause"]),b.innerHTML="PLAY"),g=!g,h=!1):(a.publishEvent("game-stateChange",["game-reset"]),setTimeout(function(){a.publishEvent("game-stateChange",["game-play"])},2500),f=!0,b.innerHTML="PAUSE"),e=!0},j=function(b){f&&(a.publishEvent("game-stateChange",["game-rewind"]),a.addEventListener(c,"mouseup",i),g=!g,h=!0)},k=function(c){f&&(f=!1,g=!1,a.publishEvent("game-stateChange",["game-stop"]),b.innerHTML="START"),e=!1},l=function(){b=document.getElementById("btn-play"),a.addEventListener(b,"click",i),c=document.getElementById("btn-rewind"),a.addEventListener(c,"mousedown",j),a.addEventListener(c,"mouseup",i),d=document.getElementById("btn-stop"),a.addEventListener(d,"click",k)},m=function(){};return{init:l,destroy:m}}),TETRIS.registerModule("game-keeper",function(a){var b=0,c=1,d=0,e=5,f=function(){b+=101,document.getElementById("score").innerHTML="Score: "+b,d++,c!=Math.floor(d/e)+1&&(c=Math.floor(d/e)+1,document.getElementById("level").innerHTML="Level: "+c,a.publishEvent("level-up"))},g=function(){a.subscribeEvent("row-cleared",f)},h=function(){};return{init:g,destroy:h}}),TETRIS.registerModule("game-loop",function(a){var b,c,d,e,f=1e3/15,g=1e3/30,h=function(){switch(_currTime=(new Date).getTime(),a.getGameState()){case"IS_PLAYING":e=_currTime-d,e>g&&(a.publishEvent("game-update"),d=_currTime),e=_currTime-c,e>f&&(a.clearCanvas(),a.publishEvent("game-render"),c=_currTime);break;case"IS_PAUSED":break;case"IS_STOPPED":break;case"IS_OVER":e=_currTime-c,e>f&&(a.clearCanvas(),a.publishEvent("game-render"),c=_currTime)}b=window.requestAnimationFrame(h)},i=function(){c=d=(new Date).getTime(),b||window.requestAnimationFrame(h)},j=function(){b&&window.cancelAnimationFrame(b)};return{init:i,destroy:j}}),TETRIS.registerModule("grid",function(a){var b=function(){var b,c;for(b=0;b<a.getGridData().rows;b++)for(c=0;c<a.getGridData().cols;c++)1===a.getGridData().grid[b][c]?a.drawRect(c*a.getGridData().cellSize,b*a.getGridData().cellSize,a.getGridData().cellSize,a.getGridData().cellSize,"#333"):a.drawRect(c*a.getGridData().cellSize,b*a.getGridData().cellSize,a.getGridData().cellSize,a.getGridData().cellSize,"#ddd")},c=function(b,c,e){console.log("block");for(var f=0;f<b.length;f++)if(1==b[f]){var g=c+f%4*a.getGridData().cellSize,h=e+Math.floor(f/4)*a.getGridData().cellSize;h>=0&&(a.getGridData().grid[h/a.getGridData().cellSize][g/a.getGridData().cellSize]=1)}a.setGridData("grid",a.getGridData().grid),d()},d=function(){console.log("checking rows");var b,c,d=!0;for(b=0;b<a.getGridData().rows;b++){for(d=!0,c=0;c<a.getGridData().cols;c++)if(0===a.getGridData().grid[b][c]){d=!1;break}if(d){a.getGridData().grid.splice(b,1);var e=[];for(c=0;c<a.getGridData().cols;c++)e.push(0);a.getGridData().grid.unshift(e),a.publishEvent("row-cleared")}}},e=function(b,c,d){a.getGridData().grid[b][c]=d},f=function(b){console.log("State: ",b);var c,d;switch(b){case"game-reset":for(c=0;c<a.getGridData().rows;c++)for(d=0;d<a.getGridData().cols;d++)setTimeout(e.bind(null,c,d,0),10*(10*c+d));break;case"game-stop":for(c=0;c<a.getGridData().rows;c++)for(d=0;d<a.getGridData().cols;d++)setTimeout(e.bind(null,c,d,1),10*(10*c+d))}},g=function(){var d,e,g,h=[];for(d=0;d<a.getGridData().rows;d++){for(g=[],e=0;e<a.getGridData().cols;e++)g.push(1);h.push(g)}a.setGridData("grid",h),a.subscribeEvent("game-render",b),a.subscribeEvent("sigil-fixed",c),a.subscribeEvent("game-stateChange",f)},h=function(){};return{init:g,destroy:h}}),TETRIS.registerModule("sigil",function(a){var b,c,d,e,f=[[[0],[1],[0],[0],[0],[1],[0],[0],[0],[1],[1],[0],[0],[0],[0],[0]],[[0],[0],[1],[0],[0],[0],[1],[0],[0],[1],[1],[0],[0],[0],[0],[0]],[[0],[0],[0],[0],[0],[1],[1],[0],[0],[1],[1],[0],[0],[0],[0],[0]],[[0],[0],[0],[0],[1],[1],[1],[0],[0],[1],[0],[0],[0],[0],[0],[0]],[[0],[1],[0],[0],[0],[1],[0],[0],[0],[1],[0],[0],[0],[1],[0],[0]],[[0],[0],[1],[0],[0],[1],[1],[0],[0],[1],[0],[0],[0],[0],[0],[0]],[[0],[1],[0],[0],[0],[1],[1],[0],[0],[0],[1],[0],[0],[0],[0],[0]]],g=2,h=0,j=4,k=f[Math.floor(Math.random()*f.length)],l=function(){if(e)for(var f=0;f<e.length;f++){var g=c+Math.floor(f%j)*b,h=d+Math.floor(f/j)*b;1===e[f][0]&&a.drawRect(g,h,b,b,"#52bbae")}},m=function(){h+=g,h>=b&&(h=0,n("down"))},n=function(f){if(e)switch(f){case"right":r(e,b,0)&&(c+=b);break;case"left":r(e,-b,0)&&(c-=b);break;case"down":r(e,0,b)?d+=b:(a.publishEvent("sigil-fixed",[e,c,d]),t())}},o=function(){var a=[],b=0;for(a.length=e.length,b=0;b<e.length;b++){var c=b%j,d=Math.floor(b/j),f=j-d-1,g=c,h=g*j+f;a[h]=e[b]}q(a)&&(e=a)},p=function(){g+=2},q=function(e){var f,g;for(i=0;i<e.length;i++)if(1==e[i]){if(f=c+Math.floor(i%j)*b,g=d+Math.floor(i/j)*b,f<0)return!!r(e,b,0)&&(c+=f*-1,!0);if(f>=a.getGridData().width)return!!r(e,-b,0)&&(c+=f-(a.getGridData().width+b),!0);if(g>=a.getGridData().height)return d+=g-(a.getGridData().height+b),!0;if(1===a.checkCell(f,g))return f-c>=80?!!r(e,-b,0)&&(c-=b,!0):!!r(e,+b,0)&&(c+=b,!0)}return!0},r=function(e,f,g){for(i=0;i<e.length;i++){var h=c+Math.floor(i%j)*b+f,k=d+Math.floor(i/j)*b+g;if(1==e[i]){if(h<0||h>=a.getGridData().width)return!1;if(k>=a.getGridData().height)return!1;if(1===a.checkCell(h,k))return!1}}return!0},s=function(a){switch(a.keyCode){case 37:n("left");break;case 38:o();break;case 39:n("right");break;case 40:n("down")}},t=function(){c=3*b,d=0,e=k,k=f[Math.floor(Math.random()*f.length)];for(var g=0;g<Math.floor(3*Math.random());g++)o();r(e,0,-b)&&(d-=b),q(e)||(console.log("DEAD!!!"),a.publishEvent("game-stateChange",["game-stop"]))},u=function(){e=[]},v=function(a){switch(a){case"game-play":t();break;case"game-stop":u()}},w=function(){b=a.getGridData().cellSize,a.addEventListener(window,"keydown",s),a.subscribeEvent("game-stateChange",v),a.subscribeEvent("game-render",l),a.subscribeEvent("game-update",m),a.subscribeEvent("level-up",p)},x=function(){};return{init:w,destroy:x}}),TETRIS.initGame("game-canvas",300,600,30),TETRIS.initModule("game-loop"),TETRIS.initModule("grid"),TETRIS.initModule("sigil"),TETRIS.initModule("game-controller"),TETRIS.initModule("game-keeper");